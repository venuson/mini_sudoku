{"version":3,"sources":["file:///Users/ruiwei/Documents/cocos/SudokuWechatGame/assets/scripts/managers/EffectsManager.ts"],"names":["_decorator","Component","Prefab","instantiate","ParticleSystem2D","error","warn","Vec3","tween","UIOpacity","isValid","UITransform","Constants","ccclass","property","EffectsManager","type","tooltip","_winParticlesNode","_isInitialized","instance","_instance","onLoad","console","log","destroy","onDestroy","playWinEffect","parentNode","position","winParticlesPrefab","ps","getComponent","stop","clear","setPosition","parentUITransform","height","play","Object","keys","addChild","particleSystem","stopWinEffect","animateNumberAppear","targetNode","callback","setScale","Animation","NUMBER_APPEAR_SCALE_IN","uiOpacity","addComponent","opacity","active","to","NUMBER_APPEAR_DURATION","scale","NUMBER_APPEAR_SCALE_OUT","easing","call","start","animateNumberDisappear","NUMBER_DISAPPEAR_DURATION","NUMBER_DISAPPEAR_SCALE"],"mappings":"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","sourcesContent":["// assets/scripts/managers/EffectsManager.ts\n\nimport { _decorator, Component, Node, Prefab, instantiate, ParticleSystem2D, error, warn, log, Vec3, tween, UIOpacity, isValid ,UITransform} from 'cc';\nimport { Constants } from '../utils/Constants';\n\nconst { ccclass, property } = _decorator;\n\n@ccclass('EffectsManager')\nexport class EffectsManager extends Component {\n    // --- Singleton Instance ---\n    private static _instance: EffectsManager | null = null;\n    public static get instance(): EffectsManager {\n        if (!this._instance) {\n            error(\"[EffectsManager] 实例在初始化之前或节点不存在时被请求。\");\n        }\n        return this._instance!;\n    }\n\n    // --- Editor Properties ---\n    @property({ type: Prefab, tooltip: \"胜利时播放的粒子效果预制件\" })\n    private winParticlesPrefab: Prefab | null = null;\n\n    // --- Private State ---\n    private _winParticlesNode: Node | null = null; // 缓存实例化的粒子节点\n    private _isInitialized: boolean = false;\n\n    // --- Lifecycle Callbacks ---\n    protected onLoad(): void {\n        console.log('[EffectsManager] onLoad');\n        if (EffectsManager._instance && EffectsManager._instance !== this) {\n            warn('[EffectsManager] 另一个实例已存在，销毁当前实例。');\n            this.destroy();\n            return;\n        }\n        EffectsManager._instance = this;\n\n        // 如果挂载在 AudioManagerNode 或其他需要持久化的节点上，则不需要再次设置持久化\n        // 如果是独立节点，则需要设置：\n        // if (this.node.parent) {\n        //     director.addPersistRootNode(this.node);\n        //     console.log('[EffectsManager] 节点已设为持久化。');\n        // }\n\n        this._isInitialized = true;\n        console.log('[EffectsManager] 初始化完成。');\n    }\n\n    protected onDestroy(): void {\n        console.log('[EffectsManager] onDestroy');\n        if (EffectsManager._instance === this) {\n            EffectsManager._instance = null;\n            // 清理可能存在的粒子节点\n            if (isValid(this._winParticlesNode)) {\n                this._winParticlesNode.destroy();\n                this._winParticlesNode = null;\n            }\n        }\n    }\n\n    // --- Public Methods ---\n\n    /**\n     * 播放胜利粒子效果。\n     * @param parentNode 粒子效果应该添加到的父节点 (通常是主游戏场景的 Canvas 或特定层)。\n     * @param position (可选) 粒子效果在父节点坐标系下的生成位置，默认为底部中心。\n     */\n    public playWinEffect(parentNode: Node, position?: Vec3): void {\n        if (!this._isInitialized) {\n            warn('[EffectsManager] playWinEffect 在初始化之前被调用。');\n            return;\n        }\n        if (!this.winParticlesPrefab) {\n            error('[EffectsManager] 胜利粒子效果预制件未设置！');\n            return;\n        }\n        if (!isValid(parentNode)) {\n             error('[EffectsManager] 提供的父节点无效！');\n             return;\n        }\n\n        // 如果粒子节点已存在且有效，先停止并重置，然后重新播放\n        if (isValid(this._winParticlesNode)) {\n            console.log('[EffectsManager] 检测到已存在的胜利粒子节点，准备重新播放。');\n            const ps = this._winParticlesNode!.getComponent(ParticleSystem2D);\n            if (ps) {\n                console.log('[EffectsManager] 检测到已存在的胜利粒子效果，准备重新播放。');\n                ps.stop(); // 停止当前的发射\n                ps.clear(); // 清除已有的粒子\n                // 重新设置位置（如果提供了）\n                if (position) {\n                    console.log('[EffectsManager] 重新设置粒子位置为:', position);\n                    this._winParticlesNode!.setPosition(position);\n                } else {\n                     // 默认位置：父节点底部中心 (需要父节点有 UITransform)\n                     console.log('[EffectsManager] ParticleSystem2D无效， 使用父节点的 UITransform 设置粒子位置。');\n                     const parentUITransform = parentNode.getComponent(UITransform);\n                     if (parentUITransform) {\n                         this._winParticlesNode!.setPosition(0, -parentUITransform.height / 2, 0);\n                     } else {\n                         this._winParticlesNode!.setPosition(0, 0, 0); // Fallback\n                     }\n                }\n                if(ps && typeof ps.play === 'function'){\n                    console.log('[EffectsManager] 粒子系统属性:', Object.keys(ps));\n                    ps.play(); // 重新开始播放\n                } else {\n                    console.log('[EffectsManager] 粒子系统没有 play 方法。');\n                }\n                \n                console.log('[EffectsManager] 重新播放胜利粒子效果。');\n                return;\n            } else {\n                 // 节点存在但没有粒子组件？销毁它重新创建\n                 console.log('[EffectsManager] 节点存在但没有 ParticleSystem 组件，重新创建。');\n                 this._winParticlesNode.destroy();\n                 this._winParticlesNode = null;\n            }\n        }\n\n\n        // 实例化粒子效果\n        console.log('[EffectsManager] 开始实例化胜利粒子效果。');\n        this._winParticlesNode = instantiate(this.winParticlesPrefab);\n        if (!this._winParticlesNode) {\n             error('[EffectsManager] 实例化胜利粒子效果失败！');\n             return;\n        }\n        \n\n        // 设置父节点和位置\n        parentNode.addChild(this._winParticlesNode);\n        if (position) {\n            this._winParticlesNode.setPosition(position);\n        } else {\n            // 默认位置：父节点底部中心\n            console.log('[EffectsManager] position不存在， 使用父节点的 UITransform 设置粒子位置。');\n            const parentUITransform = parentNode.getComponent(UITransform);\n            if (parentUITransform) {\n                console.log('[EffectsManager] 设置粒子位置为:', 0, -parentUITransform.height / 2, 0);\n                this._winParticlesNode.setPosition(0, -parentUITransform.height / 2, 0);\n            } else {\n                console.log('[EffectsManager] 使用父节点的 Transform 设置粒子位置。');\n                 this._winParticlesNode.setPosition(0, 0, 0);\n            }\n        }\n\n        // 获取粒子系统组件并播放\n        console.log('[EffectsManager] 实例化完成，准备播放粒子效果。');\n        const particleSystem = this._winParticlesNode!.getComponent(ParticleSystem2D);\n        if (particleSystem) {\n            console.log('[EffectsManager] 开始播放胜利粒子效果。');\n            console.log('[EffectsManager] 粒子系统属性:', Object.keys(particleSystem));\n            if (typeof particleSystem.play === 'function') {\n                particleSystem.play();\n            }\n        } else {\n            console.error('[EffectsManager] 胜利粒子预制件上缺少 ParticleSystem 组件！');\n        }\n    }\n\n    /**\n     * 停止并移除胜利粒子效果。\n     */\n    public stopWinEffect(): void {\n        if (!this._isInitialized) {\n            warn('[EffectsManager] stopWinEffect 在初始化之前被调用。');\n            return;\n        }\n\n        if (isValid(this._winParticlesNode)) {\n            console.log('[EffectsManager] 检测到正在播放的胜利粒子节点，准备停止。');\n            const ps = this._winParticlesNode!.getComponent(ParticleSystem2D);\n            if (ps) {\n                console.log('[EffectsManager] 检测到粒子系统组件，准备停止粒子效果。');\n                if (typeof ps.stop === 'function') {\n                    ps.stop();    \n                } else {\n                    console.log('[EffectsManager] 粒子系统没有 stop 方法。');\n                }\n                \n                // 或者立即销毁\n                 this._winParticlesNode.destroy();\n                 this._winParticlesNode = null;\n                 console.log('[EffectsManager] 胜利粒子效果已停止并移除。');\n\n            } else {\n                // 没有粒子组件，直接销毁节点\n                console.log('[EffectsManager] 检测到节点没有 ParticleSystem 组件，直接销毁。');\n                this._winParticlesNode.destroy();\n                this._winParticlesNode = null;\n                 console.log('[EffectsManager] 胜利粒子节点已移除 (无粒子系统)。');\n            }\n        } else {\n            // console.log('[EffectsManager] 没有正在播放的胜利粒子效果可停止。');\n        }\n    }\n\n    /**\n     * 播放数字出现的动画 (放大弹跳)。\n     * @param targetNode 要应用动画的数字节点 (通常是一个包含 Sprite 的节点)。\n     * @param callback (可选) 动画完成后的回调函数。\n     */\n    public animateNumberAppear(targetNode: Node, callback?: () => void): void {\n        if (!this._isInitialized || !isValid(targetNode)) {\n            warn('[EffectsManager] animateNumberAppear 调用时参数无效或未初始化。');\n            if (callback) callback();\n            return;\n        }\n\n        // 确保节点初始状态正确 (如果需要的话)\n        targetNode.setScale(Constants.Animation.NUMBER_APPEAR_SCALE_IN, Constants.Animation.NUMBER_APPEAR_SCALE_IN);\n        const uiOpacity = targetNode.getComponent(UIOpacity) || targetNode.addComponent(UIOpacity);\n        uiOpacity.opacity = 0;\n        targetNode.active = true; // 确保节点是激活的\n\n        // 创建并执行动画\n        tween(targetNode)\n            .to(Constants.Animation.NUMBER_APPEAR_DURATION * 0.7, // 70% 时间放大\n                { scale: new Vec3(Constants.Animation.NUMBER_APPEAR_SCALE_OUT, Constants.Animation.NUMBER_APPEAR_SCALE_OUT, 1) },\n                { easing: 'sineOut' } // 使用缓动效果\n            )\n            .to(Constants.Animation.NUMBER_APPEAR_DURATION * 0.3, // 30% 时间缩小回正常\n                { scale: new Vec3(1, 1, 1) },\n                { easing: 'sineIn' }\n            )\n            .call(() => {\n                // 动画完成后的回调\n                if (callback) {\n                    callback();\n                }\n            })\n            .start(); // 启动动画\n\n        // 同时处理透明度\n        tween(uiOpacity)\n            .to(Constants.Animation.NUMBER_APPEAR_DURATION * 0.5, { opacity: 255 }) // 较快达到完全不透明\n            .start();\n    }\n\n    /**\n     * 播放数字消失的动画 (缩小消失)。\n     * @param targetNode 要应用动画的数字节点。\n     * @param callback (可选) 动画完成后的回调函数 (通常用于在动画后实际移除节点或数据)。\n     */\n    public animateNumberDisappear(targetNode: Node, callback?: () => void): void {\n        if (!this._isInitialized || !isValid(targetNode)) {\n            warn('[EffectsManager] animateNumberDisappear 调用时参数无效或未初始化。');\n            if (callback) callback();\n            return;\n        }\n\n        const uiOpacity = targetNode.getComponent(UIOpacity) || targetNode.addComponent(UIOpacity);\n\n        // 创建并执行动画\n        tween(targetNode)\n            .to(Constants.Animation.NUMBER_DISAPPEAR_DURATION,\n                { scale: new Vec3(Constants.Animation.NUMBER_DISAPPEAR_SCALE, Constants.Animation.NUMBER_DISAPPEAR_SCALE, 1) },\n                { easing: 'sineIn' } // 加速消失\n            )\n            .call(() => {\n                // 动画完成后的回调\n                // targetNode.active = false; // 动画结束后隐藏节点\n                if (callback) {\n                    callback();\n                }\n            })\n            .start(); // 启动动画\n\n        // 同时处理透明度\n        tween(uiOpacity)\n            .to(Constants.Animation.NUMBER_DISAPPEAR_DURATION, { opacity: 0 })\n            .start();\n    }\n}\n"]}